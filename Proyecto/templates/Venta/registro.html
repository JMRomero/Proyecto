{%load static%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/css/font-awesome.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/diseño.css' %}">
    <link href='https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css'rel='stylesheet'>
    <title>Registra Usuario</title>
</head>
<body>
  {%include 'Layout/Menu.html' %}
    <nav class="navbar navbar-expand-lg " style="background-color: #0d6efd;" data-bs-theme="green">
            <div class="container-fluid">
              <a class="navbar-brand mx-auto text-white mb-2 h2 fs-2">Registro venta</a>
            </div>
            <ul class="right hide-on-med-and-down">
            </ul>
          </nav>
    <br>
    <form action="" id="productos" class=" needs-validation">
      <input type="hidden" id="Primer_registo" value="1">
      <input type="hidden" id="ID_Venta" value="0">
      <input type="hidden" id="cedula" value='{{user}}'>
      <div class="tableWrap">
    <table class="table table-fixed">
        <thead >
            <th>codigo</th>
            <th>nombre</th>
            <th>Miligramo/ML</th>
            <th>precio</th>
            <th>cantidad</th>
            <th>subtotal</th>
            <th>Cancelar</th>
        </thead>
        <tbody id="fila">
          <tr id="1">
            <td id="codigoPp1"><input type="number" class="form-control" id="codigoP1" required>
              <div class="invalid-feedback"><h6>Falta Codigo De Barras</h6></div></td>
              <input type="hidden" id="PosicionTabla1" value="1">
              <td id="Nombre1"></td>
              <td id="Miligramo1" ></td>
              <td id="Precio1"></td>
              <td id="Cantidad1"><input type="hidden" id="cantidadP1" value="0"></td>
              <td id="Subtotal1"></td>
              <td id="eliminar1"></td>
            </tr>
        </tbody>
    </table>
  </div>
    </form>
    <a style="margin-left: 1300px; margin-top: -1100px;" class="btn btn-danger btn-lg" id="BotonCancelar">Cancelar y nuevo</a>
    <a style="margin-left: 1300px; margin-top: -1000px;" class="btn btn-primary btn-lg" id="BotonTerminar">Terminar y nuevo</a>
  </div>
  {%include 'Layout/Validacion.html' %}
  <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>

  <script>
    let cont=1
    document.getElementById('productos').addEventListener('submit', function(event){
      event.preventDefault();//prevenir el comportamiento predeterminado del formulario
      let cantidad =document.getElementById('cantidadP'+cont).value;
      if (cantidad==0){
        let codigo=document.getElementById('codigoP'+cont).value;
        let crearventa = document.getElementById('Primer_registo').value;
        let usuario= document.getElementById('cedula').value;
        let url ="/Producto/API/"+codigo
        fetch(url)
        .then(data=>data.json())
        .then(data=> {
            if (data.length==0){
                alert("No existe un producto con esta Codigo! ")
            }else{    
            if (crearventa==1){
              let url="/Venta/API/crear/"+usuario
              fetch(url)
              .then(data=>data.json())
              .then(data=>{
                document.getElementById('ID_Venta').value=data.id_venta;
                document.getElementById('Primer_registo').value=0;
              })
            }
            document.getElementById('codigoPp'+cont).innerHTML=codigo
            document.getElementById('Nombre'+cont).innerHTML=data[0].Nombre
            document.getElementById('Miligramo'+cont).innerHTML=data[0].GramoLitro
            document.getElementById('Precio'+cont).innerHTML=data[0].precio
            document.getElementById('Cantidad'+cont).innerHTML='<input type="number" class="form-control" id="cantidadP'+cont+'" Min="1" Max="'+data[0].cantidad+'" required>'
            $("#cantidadP"+cont).focus()
            }
        })
    }else{
      let posicion= document.getElementById('PosicionTabla'+cont).value;
      let codigo=document.getElementById('codigoPp'+cont).textContent;
      let url='/Venta/API/detalle/'+codigo+'/'+cantidad+''+posicion;
      fetch(url)
        .then(data=>data.json())
        .then(data=> {
          document.getElementById('Subtotal'+(cont-1)).innerHTML=data.Subtotal;    
        });
      document.getElementById('Cantidad'+cont).innerHTML=cantidad;
      ventaid=document.getElementById('ID_Venta').value;
      posicion=document.getElementById('PosicionTabla'+cont).value;
      let c="'";
      console.log(c)
      document.getElementById('eliminar'+cont).innerHTML='<i class="fa fa-pencil-square-o fa-lg ms-4" aria-hidden="true" onclick="eliminar('+c+''+ventaid+''+c+','+c+''+posicion+''+c+')"></i>'
      document.getElementById('BotonCancelar').innerHTML='<a class="btn btn-danger " id="BotonCancelar" onclick=Cancelar('+c+''+ventaid+''+c+')>Cancelar y Nuevo</a>'
      document.getElementById('BotonTerminar').innerHTML='<a class="btn btn-primary " id="BotonTerminar" onclick=Terminar('+c+''+ventaid+''+c+')>Terminar y Nuevo</a>'
      cont=cont+1;
      $('#fila').append('\
      <tr id="'+cont+'">\
      <td id="codigoPp'+cont+'"><input type="number" class="form-control" id="codigoP'+cont+'" required>\
              <div class="invalid-feedback"><h6>Falta Codigo De Barras</h6></div></td>\
              <input type="hidden" id="PosicionTabla'+cont+'" value="'+cont+'">\
      <td id="Nombre'+cont+'"></td>\
      <td id="Miligramo'+cont+'" ></td>\
      <td id="Precio'+cont+'"></td>\
      <td id="Cantidad'+cont+'"><input type="hidden" id="cantidadP'+cont+'" value="0"></td>\
      <td id="Subtotal'+cont+'"></td>\
      <td id="eliminar'+cont+'"></td>\
      </tr>\
      ');
      $("#codigoP"+cont).focus();
    }})

    function eliminar(idventa,posicion){
      confirmar=confirm('Eliminar?')
      if (confirmar){
        let url="/Venta/API/eliminar/"+idventa+posicion;
        fetch(url)
        $('#'+posicion).remove()
      }
    }
    function Cancelar(idventa){
      confirmar=confirm('Eliminar????')
      if (confirmar){
        let url="/Venta/API/Cancelar/"+idventa;
        fetch(url)
        location.reload('/Venta/registar')
      }
    }
    function Terminar(idventa){
      pago=prompt('Digite el pago recibido')
      console.log(pago);
      if(pago!=null){
        if(pago<=0){
          alert("Debe ser mayor a 0!")
        }else{
      let url="/Venta/Terminar/API/"+idventa+"/"+pago;
      fetch(url)
      .then(devolver=>devolver.json())
      .then(devolver=>{
        alert("debes devolver "+devolver.Devolver+"$")
        location.reload('/Venta/registar')
      })
      }
    }
    }
    window.addEventListener('beforeunload', function (e) {
    e.preventDefault();
    // Mensaje personalizado utilizando un cuadro de diálogo de confirmación
    confirmationMessage=confirm( '¿Estás seguro de que deseas recargar la página?');
    return confirmationMessage; // Para navegadores modernos
});
  </script>
</body>